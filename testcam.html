<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AR Duck Marker</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw !important;
            height: 100vh !important;
        }

        #startButton{
            position:absolute;
            z-index:10;
            top:10px;
            left:10px;
            padding:10px 20px;
            font-size:16px;
            background:#4caf50;
            border:0;
            color:white;
            border-radius:5px;
            cursor:pointer;
        }
    </style>
</head>
<body>

<button id="startButton">START AR</button>

<!-- THREE -->
<script src="https://cdn.jsdelivr.net/npm/three@0.128/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/loaders/GLTFLoader.js"></script>

<!-- AR.JS -->
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/three.js/build/ar-threex.js"></script>

<script>
let scene, camera, renderer;
let arToolkitSource, arToolkitContext;
let markerRoot, duck;

document.getElementById("startButton").onclick = init;

function init(){

    document.getElementById("startButton").style.display = "none";

    // ─────────────────────────────────────────────
    // SCENE
    // ─────────────────────────────────────────────
    scene = new THREE.Scene();

    camera = new THREE.Camera();
    scene.add(camera);

    renderer = new THREE.WebGLRenderer({
        antialias:true,
        alpha:true
    });

    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);

    document.body.appendChild(renderer.domElement);

    // ─────────────────────────────────────────────
    // CAMERA SOURCE
    // ─────────────────────────────────────────────
    arToolkitSource = new THREEx.ArToolkitSource({
        sourceType: 'webcam',
        sourceWidth: window.innerWidth,
        sourceHeight: window.innerHeight,
        displayWidth: window.innerWidth,
        displayHeight: window.innerHeight
    });

    arToolkitSource.init(() => {
        setTimeout(onResize,200);
    });

    window.addEventListener('resize', onResize);

    // ─────────────────────────────────────────────
    // AR TOOLKIT
    // ─────────────────────────────────────────────
    arToolkitContext = new THREEx.ArToolkitContext({
        cameraParametersUrl:
            'https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/data/data/camera_para.dat',
        detectionMode: 'mono'
    });

    arToolkitContext.init(() => {
        camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
    });

    // ─────────────────────────────────────────────
    // MARKER
    // ─────────────────────────────────────────────
    markerRoot = new THREE.Group();
    scene.add(markerRoot);

    new THREEx.ArMarkerControls(arToolkitContext, markerRoot, {
        type: 'pattern',
        patternUrl:
          'https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/data/data/patt.hiro',
        changeMatrixMode: 'modelViewMatrix'
    });

    // ─────────────────────────────────────────────
    // LIGHT
    // ─────────────────────────────────────────────
    scene.add(new THREE.AmbientLight(0xffffff,0.6));

    const light = new THREE.DirectionalLight(0xffffff,0.8);
    light.position.set(1,1,1);
    scene.add(light);

    // ─────────────────────────────────────────────
    // LOAD DUCK
    // ─────────────────────────────────────────────
    new THREE.GLTFLoader().load(
        'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Duck/glTF-Binary/Duck.glb',
        gltf=>{
            duck = gltf.scene;

            duck.scale.set(0.5,0.5,0.5);
            duck.position.y = 0.5;

            markerRoot.add(duck);
        }
    );

    animate();
}


// ─────────────────────────────────────────────
function onResize(){
    if (!arToolkitSource) return;

    arToolkitSource.onResize();
    arToolkitSource.copySizeTo(renderer.domElement);

    if (arToolkitContext && arToolkitContext.arController){
        arToolkitSource.copySizeTo(arToolkitContext.arController.canvas);
    }
}


// ─────────────────────────────────────────────
function animate(){
    requestAnimationFrame(animate);

    if (arToolkitSource.ready){
        arToolkitContext.update(arToolkitSource.domElement);
    }

    if (duck){
        duck.rotation.y += 0.01;
    }

    renderer.render(scene,camera);
}
</script>

</body>
</html>
