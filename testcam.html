<!DOCTYPE html>
<html>
<head>
    <title>AR Camera with GLB Model on Marker</title>
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            font-family: Arial, sans-serif;
        }
        #info {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            z-index: 100;
            max-width: 80%;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
        }
        #startButton {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 15px 30px;
            font-size: 18px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 100;
        }
        #markerInfo {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            z-index: 100;
            max-width: 90%;
        }
        #markerImage {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 150px;
            height: 150px;
            border: 2px solid white;
            border-radius: 10px;
            z-index: 100;
            display: none;
        }
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        #video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            object-fit: cover;
        }
    </style>
</head>
<body>

<button id="startButton">START AR CAMERA</button>
<div id="info">Наведите камеру на маркер</div>
<div id="loading">Загрузка...</div>
<div id="markerInfo">Маркер не обнаружен</div>
<img id="markerImage" src="https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/hiro.png" alt="Маркер">

<video id="video" autoplay playsinline muted></video>
<canvas id="canvas"></canvas>

<!-- Подключаем необходимые библиотеки -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
<!-- Используем стабильную версию AR.js -->
<script src="https://cdn.jsdelivr.net/npm/@ar-js-org/ar.js@3.4.0/dist/ar.js"></script>

<script>
let camera, scene, renderer;
let video;
let model = null;
let arToolkitSource, arToolkitContext;
let markerRoot = null;
let markerFound = false;

// Элементы DOM
const startButton = document.getElementById('startButton');
const infoElement = document.getElementById('info');
const loadingElement = document.getElementById('loading');
const markerInfoElement = document.getElementById('markerInfo');
const markerImageElement = document.getElementById('markerImage');
const videoElement = document.getElementById('video');
const canvas = document.getElementById('canvas');

// URL маркера (замените на свой) 
const MARKER_PATTERN_URL = './pattern-marker.patt'; // URL изображения маркера для отображения 
const MARKER_IMAGE_URL = './pattern-marker.patt';

// Начало работы с AR камерой
async function startCamera() {
    try {
        startButton.style.display = 'none';
        loadingElement.style.display = 'block';
        loadingElement.textContent = 'Инициализация камеры...';
        
        markerImageElement.style.display = 'block';
        
        // Запрос доступа к камере
        const constraints = {
            video: {
                facingMode: { ideal: "environment" },
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        };
        
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        videoElement.srcObject = stream;
        
        // Ждем, пока видео будет готово
        await new Promise((resolve) => {
            videoElement.onloadedmetadata = () => {
                videoElement.play();
                resolve();
            };
        });
        
        initAR();
        loadGLBModel();
        
    } catch(e) {
        console.error("Ошибка камеры:", e);
        alert("Ошибка доступа к камере: " + e.message);
        startButton.style.display = 'block';
        loadingElement.style.display = 'none';
    }
}

// Инициализация AR с использованием AR.js
function initAR() {
    loadingElement.textContent = 'Инициализация AR...';
    
    // Создаем сцену
    scene = new THREE.Scene();
    
    // Создаем камеру
    camera = new THREE.Camera();
    scene.add(camera);
    
    // Создаем рендерер
    renderer = new THREE.WebGLRenderer({ 
        canvas: canvas,
        alpha: true,
        antialias: true
    });
    renderer.setClearColor(new THREE.Color('lightgrey'), 0);
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    
    // Инициализируем AR.js
    arToolkitSource = new THREEx.ArToolkitSource({
        sourceType: 'webcam',
    });
    
    arToolkitSource.init(function onReady() {
        // Копируем размеры элемента
        arToolkitSource.onResize();
        arToolkitSource.copyElementSizeTo(renderer.domElement);
        
        if (arToolkitContext) {
            arToolkitContext.arController.copyElementSizeTo(renderer.domElement);
        }
    });
    
    // Создаем AR контекст
    arToolkitContext = new THREEx.ArToolkitContext({
        cameraParametersUrl: 'https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/data/camera_para.dat',
        detectionMode: 'mono',
        patternRatio: 0.5,
        maxDetectionRate: 60,
        canvasWidth: 640,
        canvasHeight: 480,
    });
    
    // Инициализируем контекст
    arToolkitContext.init(function() {
        // Копируем матрицу проекции
        camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
    });
    
    // Создаем корневой объект для маркера
    markerRoot = new THREE.Group();
    scene.add(markerRoot);
    
    // Создаем контролы для маркера
    const markerControls = new THREEx.ArMarkerControls(arToolkitContext, markerRoot, {
        type: 'pattern',
        patternUrl: MARKER_PATTERN_URL,
        changeMatrixMode: 'cameraTransformMatrix'
    });
    
    // Освещение
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
    scene.add(ambientLight);
    
    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
    directionalLight.position.set(1, 1, 1);
    scene.add(directionalLight);
    
    // Обработчик изменения размера окна
    window.addEventListener('resize', function() {
        if (arToolkitSource) {
            arToolkitSource.onResize();
            arToolkitSource.copyElementSizeTo(renderer.domElement);
        }
        if (arToolkitContext) {
            arToolkitContext.arController.copyElementSizeTo(renderer.domElement);
        }
    });
    
    // Начинаем анимацию
    animate();
}

// Загрузка GLB модели
function loadGLBModel() {
    const loader = new THREE.GLTFLoader();
    
    // Загружаем модель утки
    const modelUrl = 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Duck/glTF-Binary/Duck.glb';
    
    loadingElement.textContent = 'Загрузка модели...';
    
    loader.load(
        modelUrl,
        function(gltf) {
            model = gltf.scene;
            
            // Настраиваем модель
            model.scale.set(0.05, 0.05, 0.05);
            model.rotation.y = Math.PI;
            model.visible = false;
            
            // Добавляем модель к маркеру
            if (markerRoot) {
                markerRoot.add(model);
            } else {
                scene.add(model);
            }
            
            loadingElement.style.display = 'none';
            infoElement.textContent = 'Наведите камеру на маркер справа вверху';
            console.log('Модель загружена успешно');
        },
        function(xhr) {
            const percent = Math.round((xhr.loaded / xhr.total) * 100);
            loadingElement.textContent = `Загрузка модели... ${percent}%`;
        },
        function(error) {
            loadingElement.style.display = 'none';
            console.error('Ошибка загрузки модели:', error);
            // Используем куб как запасной вариант
            createFallbackModel();
        }
    );
}

// Создание запасной модели (если GLB не загрузится)
function createFallbackModel() {
    console.log('Создание запасной модели...');
    
    const geometry = new THREE.BoxGeometry(0.5, 0.5, 0.5);
    const material = new THREE.MeshNormalMaterial();
    model = new THREE.Mesh(geometry, material);
    model.visible = false;
    
    if (markerRoot) {
        markerRoot.add(model);
    } else {
        scene.add(model);
    }
    
    loadingElement.style.display = 'none';
    infoElement.textContent = 'Наведите камеру на маркер справа вверху';
}

// Анимация
function animate() {
    requestAnimationFrame(animate);
    
    // Обновляем AR контекст
    if (arToolkitSource && arToolkitSource.ready) {
        arToolkitContext.update(arToolkitSource.domElement);
        
        // Проверяем видимость маркера
        if (markerRoot) {
            const wasFound = markerFound;
            markerFound = markerRoot.visible;
            
            if (model) {
                model.visible = markerFound;
                
                // Если маркер обнаружен, вращаем модель
                if (markerFound) {
                    model.rotation.y += 0.01;
                }
            }
            
            // Обновляем информацию о статусе маркера
            if (markerFound && !wasFound) {
                markerInfoElement.textContent = '✅ Маркер обнаружен!';
                markerInfoElement.style.background = 'rgba(0, 255, 0, 0.7)';
            } else if (!markerFound && wasFound) {
                markerInfoElement.textContent = '❌ Маркер не обнаружен';
                markerInfoElement.style.background = 'rgba(255, 0, 0, 0.7)';
            }
        }
    }
    
    // Рендерим сцену
    renderer.render(scene, camera);
}

// Альтернативная простая реализация (если AR.js не работает)
function initSimpleAR() {
    console.log('Используется упрощенная реализация AR');
    
    loadingElement.textContent = 'Инициализация упрощенного AR...';
    
    // Создаем сцену
    scene = new THREE.Scene();
    
    // Создаем камеру
    camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 0, 5);
    
    // Создаем рендерер
    renderer = new THREE.WebGLRenderer({ 
        canvas: canvas,
        alpha: true,
        antialias: true
    });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    
    // Создаем видео текстуру
    const videoTexture = new THREE.VideoTexture(videoElement);
    videoTexture.minFilter = THREE.LinearFilter;
    videoTexture.magFilter = THREE.LinearFilter;
    videoTexture.format = THREE.RGBFormat;
    
    // Создаем плоскость для видео фона
    const videoGeometry = new THREE.PlaneGeometry(16, 9);
    const videoMaterial = new THREE.MeshBasicMaterial({ 
        map: videoTexture,
        side: THREE.DoubleSide 
    });
    const videoPlane = new THREE.Mesh(videoGeometry, videoMaterial);
    videoPlane.position.z = -10;
    scene.add(videoPlane);
    
    // Освещение
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
    scene.add(ambientLight);
    
    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
    directionalLight.position.set(1, 1, 1);
    scene.add(directionalLight);
    
    // Загружаем модель
    loadGLBModel();
    
    // Обработчик изменения размера
    window.addEventListener('resize', function() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });
    
    // Анимация
    function animateSimple() {
        requestAnimationFrame(animateSimple);
        
        if (model) {
            model.rotation.y += 0.01;
        }
        
        renderer.render(scene, camera);
    }
    
    animateSimple();
    loadingElement.style.display = 'none';
    infoElement.textContent = 'Упрощенный режим. Модель отображается в центре.';
    markerInfoElement.textContent = '⚠️ Используется упрощенный режим (без отслеживания маркера)';
    markerInfoElement.style.background = 'rgba(255, 165, 0, 0.7)';
}

// Назначаем обработчик кнопки
startButton.addEventListener('click', startCamera);

// Инструкция на странице
infoElement.innerHTML = `
    <strong>Инструкция:</strong><br>
    1. Нажмите START AR CAMERA<br>
    2. Разрешите доступ к камере<br>
    3. Наведите камеру на маркер справа<br>
    4. Утка появится автоматически
`;

markerInfoElement.innerHTML = `
    <strong>Статус маркера:</strong><br>
    Ожидание инициализации...
`;

// Проверяем доступность AR.js
console.log('AR.js доступен:', typeof THREEx !== 'undefined');
console.log('THREEx.ArToolkitSource доступен:', typeof THREEx?.ArToolkitSource !== 'undefined');
</script>

</body>
</html>
