<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AR Duck on Marker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, Helvetica, sans-serif;
            background: #000;
        }

        canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw !important;
            height: 100vh !important;
        }

        /* Панель UI сверху */
        #ui {
            position: absolute;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.55);
            backdrop-filter: blur(8px);
            padding: 12px 20px;
            border-radius: 16px;
            color: white;
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        #startButton {
            font-size: 18px;
            padding: 10px 24px;
            border-radius: 12px;
            border: none;
            background: #41d15c;
            color: white;
            cursor: pointer;
            transition: 0.15s;
        }

        #startButton:hover {
            transform: scale(1.05);
            background: #2bb946;
        }

        #status {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Подсказка внизу */
        #info {
            position: absolute;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.55);
            backdrop-filter: blur(6px);
            color: white;
            padding: 10px 16px;
            border-radius: 14px;
            font-size: 14px;
            z-index: 10;
            text-align: center;
        }
    </style>
</head>
<body>

<div id="ui">
    <button id="startButton">START AR</button>
    <div id="status">Нажмите START для запуска камеры</div>
</div>

<div id="info">Наведите камеру на маркер</div>

<!-- Three.js -->
<script src="https://cdn.jsdelivr.net/npm/three@0.128/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/loaders/GLTFLoader.js"></script>

<!-- AR.js -->
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/three.js/build/ar-threex.js"></script>

<script>
let scene, camera, renderer;
let arToolkitSource, arToolkitContext;
let markerRoot, duck;

// ==================
// Запуск камеры
// ==================
document.getElementById("startButton").addEventListener("click", startAR);

function startAR() {
    document.getElementById("startButton").style.display = "none";
    document.getElementById("status").innerText = "Камера запущена, ищем маркер...";

    scene = new THREE.Scene();

    camera = new THREE.Camera();
    scene.add(camera);

    renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    document.body.appendChild(renderer.domElement);

    // Камера
    arToolkitSource = new THREEx.ArToolkitSource({
        sourceType: 'webcam'
    });

    arToolkitSource.init(() => {
        onResize();
    });

    window.addEventListener('resize', onResize);

    // Контекст AR
    arToolkitContext = new THREEx.ArToolkitContext({
        cameraParametersUrl:
            'https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/data/data/camera_para.dat',
        detectionMode: 'mono'
    });

    arToolkitContext.init(() => {
        camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
    });

    // ==================
    // Маркер
    // ==================
    markerRoot = new THREE.Group();
    scene.add(markerRoot);

    new THREEx.ArMarkerControls(arToolkitContext, markerRoot, {
        type: 'pattern',
        patternUrl:
            'https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/data/data/patt.hiro'
    });

    // ==================
    // Свет
    // ==================
    scene.add(new THREE.AmbientLight(0xffffff, 0.8));
    const dir = new THREE.DirectionalLight(0xffffff, 0.8);
    dir.position.set(1, 1, 1);
    scene.add(dir);

    // ==================
    // Загрузка утки
    // ==================
    new THREE.GLTFLoader().load(
        'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Duck/glTF-Binary/Duck.glb',
        gltf => {
            duck = gltf.scene;
            duck.scale.set(0.5, 0.5, 0.5);
            duck.position.y = 0.2;

            markerRoot.add(duck);
        }
    );

    animate();
}

function onResize() {
    arToolkitSource.onResize();
    arToolkitSource.copySizeTo(renderer.domElement);
    if (arToolkitContext.arController) {
        arToolkitSource.copySizeTo(arToolkitContext.arController.canvas);
    }
}

// ==================
// Цикл рендера
// ==================
function animate() {
    requestAnimationFrame(animate);

    if (!arToolkitSource.ready) return;

    arToolkitContext.update(arToolkitSource.domElement);

    // Вращаем утку на маркере
    if (duck) {
        duck.rotation.y += 0.01;
    }

    renderer.render(scene, camera);
}
</script>

</body>
</html>
