<!DOCTYPE html>
<html>
<head>
    <title>AR Camera with GLB Model</title>
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            font-family: Arial, sans-serif;
        }
        #info {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            z-index: 100;
            max-width: 80%;
            display: none;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            z-index: 100;
        }
        #startButton {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 15px 30px;
            font-size: 18px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 100;
        }
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        #video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }
    </style>
</head>
<body>

<button id="startButton">START CAMERA</button>
<div id="info">Нажмите на экран чтобы разместить модель</div>
<div id="loading">Загрузка модели...</div>

<video id="video" autoplay playsinline muted></video>
<canvas id="canvas"></canvas>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

<script>
let camera, scene, renderer;
let video, videoTexture;
let model = null;
let modelPlaced = false;
let isDragging = false;
let previousMousePosition = { x: 0, y: 0 };

// Элементы DOM
const startButton = document.getElementById('startButton');
const infoElement = document.getElementById('info');
const loadingElement = document.getElementById('loading');
const videoElement = document.getElementById('video');
const canvas = document.getElementById('canvas');

// Начало работы с камерой
async function startCamera() {
    try {
        startButton.style.display = 'none';
        loadingElement.style.display = 'block';
        
        // Запрос доступа к камере
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: { ideal: "environment" } }
        });
        
        videoElement.srcObject = stream;
        
        // Ждем, пока видео будет готово
        videoElement.onloadedmetadata = () => {
            initThreeJS();
            loadingElement.style.display = 'none';
            infoElement.style.display = 'block';
            loadGLBModel();
        };
        
    } catch(e) {
        alert("Ошибка: " + e.name + " : " + e.message);
        startButton.style.display = 'block';
        loadingElement.style.display = 'none';
    }
}

// Инициализация Three.js
function initThreeJS() {
    const width = window.innerWidth;
    const height = window.innerHeight;
    
    // Создаем сцену
    scene = new THREE.Scene();
    
    // Создаем камеру (перспективная)
    camera = new THREE.PerspectiveCamera(60, width / height, 0.1, 1000);
    camera.position.set(0, 0, 5);
    
    // Создаем рендерер
    renderer = new THREE.WebGLRenderer({ 
        canvas: canvas,
        alpha: true,
        antialias: true 
    });
    renderer.setSize(width, height);
    renderer.setPixelRatio(window.devicePixelRatio);
    
    // Освещение
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
    scene.add(ambientLight);
    
    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
    directionalLight.position.set(1, 1, 1);
    scene.add(directionalLight);
    
    // Обработчики событий
    window.addEventListener('resize', onWindowResize);
    canvas.addEventListener('click', onCanvasClick);
    canvas.addEventListener('mousedown', onMouseDown);
    canvas.addEventListener('mousemove', onMouseMove);
    canvas.addEventListener('mouseup', onMouseUp);
    canvas.addEventListener('wheel', onMouseWheel);
    
    // Начинаем анимацию
    animate();
}

// Загрузка GLB модели
function loadGLBModel() {
    const loader = new THREE.GLTFLoader();
    
    // Загружаем модель (пример URL - замените на свою модель)
    // Можно использовать локальный файл или ссылку на GitHub
    const modelUrl = 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Duck/glTF-Binary/Duck.glb';
    
    loadingElement.style.display = 'block';
    loadingElement.textContent = 'Загрузка модели...';
    
    loader.load(
        modelUrl,
        function(gltf) {
            model = gltf.scene;
            model.scale.set(0.5, 0.5, 0.5);
            model.visible = false; // Сначала скрываем
            scene.add(model);
            
            loadingElement.style.display = 'none';
            console.log('Модель загружена успешно');
        },
        function(xhr) {
            // Прогресс загрузки
            const percent = Math.round((xhr.loaded / xhr.total) * 100);
            loadingElement.textContent = `Загрузка модели... ${percent}%`;
        },
        function(error) {
            loadingElement.style.display = 'none';
            console.error('Ошибка загрузки модели:', error);
            alert('Не удалось загрузить модель. Проверьте URL или используйте локальную модель.');
        }
    );
}

// Размещение модели при клике
function onCanvasClick(event) {
    if (model && !modelPlaced) {
        // Получаем координаты клика
        const rect = canvas.getBoundingClientRect();
        const x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
        const y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
        
        // Размещаем модель перед камерой
        model.position.set(x * 3, y * 2, -5);
        model.visible = true;
        modelPlaced = true;
        infoElement.style.display = 'none';
    }
}

// Вращение модели мышкой
function onMouseDown(event) {
    if (!model || !modelPlaced) return;
    
    isDragging = true;
    previousMousePosition = {
        x: event.clientX,
        y: event.clientY
    };
}

function onMouseMove(event) {
    if (!isDragging || !model) return;
    
    const deltaX = event.clientX - previousMousePosition.x;
    const deltaY = event.clientY - previousMousePosition.y;
    
    model.rotation.y += deltaX * 0.01;
    model.rotation.x += deltaY * 0.01;
    
    previousMousePosition = {
        x: event.clientX,
        y: event.clientY
    };
}

function onMouseUp() {
    isDragging = false;
}

function onMouseWheel(event) {
    if (!model || !modelPlaced) return;
    
    event.preventDefault();
    const zoomSpeed = 0.001;
    model.scale.x += event.deltaY * zoomSpeed;
    model.scale.y += event.deltaY * zoomSpeed;
    model.scale.z += event.deltaY * zoomSpeed;
    
    // Ограничиваем масштаб
    model.scale.x = Math.max(0.1, Math.min(2, model.scale.x));
    model.scale.y = Math.max(0.1, Math.min(2, model.scale.y));
    model.scale.z = Math.max(0.1, Math.min(2, model.scale.z));
}

function onWindowResize() {
    const width = window.innerWidth;
    const height = window.innerHeight;
    
    camera.aspect = width / height;
    camera.updateProjectionMatrix();
    renderer.setSize(width, height);
}

// Анимация
function animate() {
    requestAnimationFrame(animate);
    
    // Вращаем модель, если она размещена
    if (model && modelPlaced && !isDragging) {
        model.rotation.y += 0.005;
    }
    
    renderer.render(scene, camera);
}

// Назначаем обработчик кнопки
startButton.addEventListener('click', startCamera);

// Инструкция по использованию
console.log('Инструкция:');
console.log('1. Нажмите START CAMERA');
console.log('2. Разрешите доступ к камере');
console.log('3. Нажмите на экран, чтобы разместить модель');
console.log('4. Перетаскивайте мышкой для вращения модели');
console.log('5. Используйте колесико мыши для изменения масштаба');
</script>

</body>
</html>
