<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>AR Duck Marker — WORKING</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
    margin:0;
    background:#000;
    font-family:Arial, Helvetica, sans-serif;
}
/* Canvas всегда поверх видео и во весь экран */
canvas{
    position:fixed;
    inset:0;
    width:100vw!important;
    height:100vh!important;
}

/* Меню */
#ui{
    position:absolute;
    top:15px;
    left:50%;
    transform:translateX(-50%);
    z-index:10;
    background:rgba(0,0,0,0.55);
    backdrop-filter: blur(8px);
    padding:12px 20px;
    border-radius:14px;
    display:flex;
    gap:12px;
    align-items:center;
}

button{
    background:#4caf50;
    border:0;
    color:white;
    font-size:15px;
    padding:9px 16px;
    border-radius:10px;
    cursor:pointer;
}

button:hover{
    background:#43a047;
}

#status{
    color:#fff;
    font-size:14px;
}

#help{
    position:absolute;
    bottom:16px;
    width:100%;
    text-align:center;
    color:#fff;
    z-index:10;
    font-size:14px;
    background:rgba(0,0,0,0.5);
    padding:8px 12px;
}
</style>
</head>
<body>

<div id="ui">
    <button id="startBtn">START AR</button>
    <div id="status">Ожидание запуска…</div>
</div>

<div id="help">
    Наведите камеру на маркер <b>HIRO</b>
</div>

<!-- THREE -->
<script src="https://cdn.jsdelivr.net/npm/three@0.128/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/loaders/GLTFLoader.js"></script>

<!-- AR.JS -->
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/three.js/build/ar-threex.js"></script>

<script>
let scene,camera,renderer;
let arSource, arContext;
let markerRoot, duck;
let statusLabel = document.getElementById("status");

document.getElementById("startBtn").onclick = startAR;

function startAR(){
    document.getElementById("startBtn").style.display="none";
    statusLabel.innerText = "Запуск камеры...";

    scene = new THREE.Scene();

    camera = new THREE.Camera();
    scene.add(camera);

    renderer = new THREE.WebGLRenderer({
        antialias:true,
        alpha:true
    });

    renderer.setSize(window.innerWidth,window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    document.body.appendChild(renderer.domElement);


    /* =======================
         VIDEO SOURCE
    ======================== */
    arSource = new THREEx.ArToolkitSource({
        sourceType: "webcam",
        sourceWidth:1280,
        sourceHeight:720,
        displayWidth:window.innerWidth,
        displayHeight:window.innerHeight
    });

    arSource.init(()=>{
        statusLabel.innerText = "Камера включена";
        setTimeout(onResize,300);
    });

    window.addEventListener("resize", onResize);

    /* =======================
         AR CONTEXT
    ======================== */
    arContext = new THREEx.ArToolkitContext({
        cameraParametersUrl:
            "https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/data/data/camera_para.dat",
        detectionMode:"mono"
    });

    arContext.init(()=>{
        camera.projectionMatrix.copy(
            arContext.getProjectionMatrix()
        );
        statusLabel.innerText = "Поиск маркера...";
    });

    /* =======================
           MARKER
    ======================== */
    markerRoot = new THREE.Group();
    scene.add(markerRoot);

    new THREEx.ArMarkerControls(
        arContext,
        markerRoot,
        {
            type:"pattern",

            patternUrl:
            "https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/data/data/patt.hiro",

            smooth:true
        }
    );

    /* =======================
            LIGHT
    ======================== */
    scene.add(new THREE.AmbientLight(0xffffff,0.8));

    const dl = new THREE.DirectionalLight(0xffffff,0.7);
    dl.position.set(2,2,1);
    scene.add(dl);

    /* =======================
            MODEL
    ======================== */
    const loader = new THREE.GLTFLoader();

    loader.load(
        "https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Duck/glTF-Binary/Duck.glb",

        gltf=>{
            duck = gltf.scene;
            duck.scale.set(0.5,0.5,0.5);
            duck.position.y = 0.5;
            duck.visible = false;

            markerRoot.add(duck);
        }
    );

    animate();
}

function onResize(){
    if(!arSource) return;

    arSource.onResize();
    arSource.copySizeTo(renderer.domElement);

    if(arContext.arController){
        arSource.copySizeTo(arContext.arController.canvas);
    }
}

/* =======================
         LOOP
======================= */
function animate(){
    requestAnimationFrame(animate);

    if(arSource?.ready){
        arContext.update(arSource.domElement);
    }

    if(markerRoot){

        if(markerRoot.visible){
            statusLabel.innerText="Маркер найден ✅";

            if(duck){
                duck.visible = true;
                duck.rotation.y += 0.01;
            }

        } else{
            statusLabel.innerText="Ищем маркер...";
            if(duck) duck.visible = false;
        }
    }

    renderer.render(scene,camera);
}
</script>

</body>
</html>
